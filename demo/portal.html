<!DOCTYPE html>
<meta charset="utf-8">
<body><center></center>
<style>

path {
  fill: none;
  stroke: #000;
  stroke-width: 3px;
}

.main-circle {
  fill: transparent;
  stroke: #AEBC21;
  stroke-width: 5px;
}

.ethernet-circle-white {
  fill: #fff;
}

.ethernet-circle {
  fill: #757116;
  stroke: #fff;
  stroke-width: 3px;
}

.middle-circle-arc {
  /*fill: #AEBC21;
  stroke: #AEBC21;*/
  fill: #757116;
  stroke: #757116;
  stroke-width: 0;
}

.radio-bl-path {
  stroke: #8dc3e9;
  stroke-width: 5px;
}

.radio-bl-circle {
  fill: #8dc3e9;
  stroke: #fff;
  stroke-width: 3px;
}

.radio-bl-text {
  fill: #8dc3e9;
}

.radio-br-path {
  stroke: steelblue;
  stroke-width: 5px;
}

.radio-br-circle {
  fill: steelblue;
  stroke: #fff;
  stroke-width: 3px;
}

.radio-br-text {
  fill: steelblue;
}

.radio-tr-path {
  stroke: #00477F;
  stroke-width: 5px;
}

.radio-tr-circle {
  fill: #00477F;
  stroke: #fff;
  stroke-width: 3px;
}

.ethernet-box {
  fill: #fff;
  stroke: #757116;
  stroke-width:2px;
}

.ethernet-line {
  stroke: #757116;
  stroke-width:2px;
}

.ble-logo {
  /*fill: #0060A9;  original*/
  fill: #00477F;
  stroke: #fff;
  stroke-width:0.05px;
}

.back-img {
  opacity: 0.1;
}

.ble-adv .ble-adv-bubble {
  fill: #00477F;
  fill-opacity: 0.1;
}

.ble-adv .ble-adv-name {
  font-family: sans-serif;
  font-size: 25px;
  fill: #00477F;
}

.ble-adv .ble-adv-id {
  font-family: sans-serif;
  font-size: 18px;
  fill: #aaa;
}

.ble-adv .ble-adv-rssi-label {
  font-family: sans-serif;
  font-size: 12px;
  fill: #888;
  text-anchor: middle;
  font-weight: bold;
}

.ble-adv .ble-adv-rssi {
  font-family: sans-serif;
  font-size: 18px;
  fill: #00477F;
  text-anchor: middle;
}

.ble-adv .ble-adv-rssi-box {
  stroke: #00477F;
  fill: transparent;
}

</style>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

ble_logo_xml_d = 'M44.554,30.309l5.061,5.062     l-5.057,5.059L44.554,30.309L44.554,30.309z M44.554,61.274l5.061-5.063l-5.057-5.044L44.554,61.274L44.554,61.274z      M39.156,45.797L28.227,34.833l3.168-3.169l8.709,8.703V19.492l15.841,15.842L45.483,45.797l10.463,10.448L40.104,72.089V51.215     l-8.709,8.702l-3.168-3.169L39.156,45.797L39.156,45.797z M42.085,76.38c13.36,0,22.562-6.347,22.562-30.584     c0-24.251-9.202-30.596-22.562-30.596c-13.352,0-22.567,6.345-22.567,30.596C19.518,70.033,28.733,76.38,42.085,76.38     L42.085,76.38z'

var radio_bl_points = [
  [450, 1000],
  [400, 800],
  [425, 500],
  [550, 230],
  [600, 200]
];
var radio_br_points = [
  [750, 1000],
  [500, 700],
  [610, 400],
  [600, 200]
];
var radio_tr_points = [
  [850, 400],
  [825, 475],
  [700, 450],
  [700, 265],
  [600, 200]
];

var middle_circle_arc_spacing_deg = 30;
var middle_circle_arc_bl_hole_deg = 230;
var middle_circle_arc_br_hole_deg = 180;
var middle_circle_arc_tr_hole_deg = 125;

var ethernet_x = 510;
var ethernet_y = 220;

var radio_br_text_y = 860

var ble_adv_x_pos_left = 900
var ble_adv_y_pos_top = 200

var svg = d3.select("center").append("svg")
    .attr("width", 1200)
    .attr("height", 1200);

// Main outline
// var main_circle = svg.append("circle")
//     .attr('cx', 600)
//     .attr('cy', 600)
//     .attr('r', 400)
//     .attr('class', 'main-circle');

svg.append("svg:image")
    .attr("class", "back-img")
    .attr("xlink:href", 'bbb.jpg')
    .attr('x', 300)
    .attr('y', 200)
    .attr('width', 600)
    .attr('height', 800);

var main_rect = svg.append("rect")
    .attr('x', 350)
    .attr('y', 200)
    .attr('rx', 100)
    .attr('ry', 100)
    .attr('width', 500)
    .attr('height', 800)
    .attr('class', 'main-circle');

// Ethernet
svg.append("circle")
    .attr('cx', 600)
    .attr('cy', 200)
    .attr('r', 50)
    .attr('class', 'ethernet-circle-white');

// Middle circle (ethernet)
var middle_circle_arc_top = d3.svg.arc()
    .innerRadius(50)
    .outerRadius(55)
    .startAngle(90 * (Math.PI/180)) //converting from degs to radians
    .endAngle((middle_circle_arc_tr_hole_deg-(middle_circle_arc_spacing_deg/2)) * (Math.PI/180)) //just radians

svg.append("path")
    .attr("d", middle_circle_arc_top)
    .attr("class", "middle-circle-arc")
    .attr("transform", "translate(600,200)");

var middle_circle_arc_right = d3.svg.arc()
    .innerRadius(50)
    .outerRadius(55)
    .startAngle((middle_circle_arc_tr_hole_deg+(middle_circle_arc_spacing_deg/2)) * (Math.PI/180)) //converting from degs to radians
    .endAngle((middle_circle_arc_br_hole_deg-(middle_circle_arc_spacing_deg/2)) * (Math.PI/180)) //just radians

svg.append("path")
    .attr("d", middle_circle_arc_right)
    .attr("class", "middle-circle-arc")
    .attr("transform", "translate(600,200)");

var middle_circle_arc_left = d3.svg.arc()
    .innerRadius(50)
    .outerRadius(55)
    .startAngle((middle_circle_arc_br_hole_deg+(middle_circle_arc_spacing_deg/2)) * (Math.PI/180)) //converting from degs to radians
    .endAngle((middle_circle_arc_bl_hole_deg-(middle_circle_arc_spacing_deg/2)) * (Math.PI/180)) //just radians

svg.append("path")
    .attr("d", middle_circle_arc_left)
    .attr("class", "middle-circle-arc")
    .attr("transform", "translate(600,200)");

var middle_circle_arc_lefter = d3.svg.arc()
    .innerRadius(50)
    .outerRadius(55)
    .startAngle((middle_circle_arc_bl_hole_deg+(middle_circle_arc_spacing_deg/2)) * (Math.PI/180)) //converting from degs to radians
    .endAngle(270 * (Math.PI/180)) //just radians

svg.append("path")
    .attr("d", middle_circle_arc_lefter)
    .attr("class", "middle-circle-arc")
    .attr("transform", "translate(600,200)");



// LAN/Ethernet symbol
svg.append("rect")
    .attr('x', ethernet_x)
    .attr('y', ethernet_y)
    .attr('width', 10)
    .attr('height', 10)
    .attr('class', 'ethernet-box');
svg.append("rect")
    .attr('x', ethernet_x-10)
    .attr('y', ethernet_y+20)
    .attr('width', 10)
    .attr('height', 10)
    .attr('class', 'ethernet-box');
svg.append("rect")
    .attr('x', ethernet_x+10)
    .attr('y', ethernet_y+20)
    .attr('width', 10)
    .attr('height', 10)
    .attr('class', 'ethernet-box');
svg.append("line")
    .attr('x1', ethernet_x-12)
    .attr('y1', ethernet_y+15)
    .attr('x2', ethernet_x+22)
    .attr('y2', ethernet_y+15)
    .attr('class', 'ethernet-line');
svg.append("line")
    .attr('x1', ethernet_x-5)
    .attr('y1', ethernet_y+15)
    .attr('x2', ethernet_x-5)
    .attr('y2', ethernet_y+20)
    .attr('class', 'ethernet-line');
svg.append("line")
    .attr('x1', ethernet_x+5)
    .attr('y1', ethernet_y+15)
    .attr('x2', ethernet_x+5)
    .attr('y2', ethernet_y+10)
    .attr('class', 'ethernet-line');
svg.append("line")
    .attr('x1', ethernet_x+15)
    .attr('y1', ethernet_y+15)
    .attr('x2', ethernet_x+15)
    .attr('y2', ethernet_y+20)
    .attr('class', 'ethernet-line');


// RADIO BOTTOM LEFT
var radio_bl_path = svg.append("path")
    .data([radio_bl_points])
    .attr("class", 'radio-bl-path')
    .attr("d", d3.svg.line()
      .tension(0)
      .interpolate("basis"));

svg.append("circle")
    .attr('cx', radio_bl_points[0][0])
    .attr('cy', radio_bl_points[0][1])
    .attr('r', 20)
    .attr('class', 'radio-bl-circle');

// RADIO BOTTOM RIGHT
var radio_br_path = svg.append("path")
    .data([radio_br_points])
    .attr("class", 'radio-br-path')
    .attr("d", d3.svg.line()
      .tension(0)
      .interpolate("basis"));

svg.append("circle")
    .attr('cx', radio_br_points[0][0])
    .attr('cy', radio_br_points[0][1])
    .attr('r', 20)
    .attr('class', 'radio-br-circle');

// RADIO TOP RIGHT
var radio_tr_path = svg.append("path")
    .data([radio_tr_points])
    .attr("class", 'radio-tr-path')
    .attr("d", d3.svg.line()
      .tension(0)
      .interpolate("basis"));

svg.append("circle")
    .attr('cx', radio_tr_points[0][0])
    .attr('cy', radio_tr_points[0][1])
    .attr('r', 20)
    .attr('class', 'radio-tr-circle');

// Ethernet dot
// Has to be here for layering
svg.append("circle")
    .attr('cx', 600)
    .attr('cy', 200)
    .attr('r', 50)
    .attr('class', 'ethernet-circle');


// Add 802.15.4 + 6LoWPAN
svg.append("text")
    .text('802.15.4')
    .attr('font-family', 'sans-serif')
    .attr('font-size', '25px')
    .attr('text-anchor', 'middle')
    .attr('class', 'radio-bl-text')
    .attr('x', 520)
    .attr('y', 915);
svg.append("text")
    .text('+')
    .attr('font-family', 'sans-serif')
    .attr('font-size', '25px')
    .attr('text-anchor', 'middle')
    .attr('class', 'radio-bl-text')
    .attr('x', 520)
    .attr('y', 940);
svg.append("text")
    .text('6LoWPAN')
    .attr('font-family', 'sans-serif')
    .attr('font-size', '25px')
    .attr('text-anchor', 'middle')
    .attr('class', 'radio-bl-text')
    .attr('x', 520)
    .attr('y', 965);


// Add 802.15.4 + 6LoWPAN + RPL
svg.append("text")
    .text('802.15.4')
    .attr('font-family', 'sans-serif')
    .attr('font-size', '25px')
    .attr('text-anchor', 'middle')
    .attr('class', 'radio-br-text')
    .attr('x', 770)
    .attr('y', radio_br_text_y);
svg.append("text")
    .text('+')
    .attr('font-family', 'sans-serif')
    .attr('font-size', '25px')
    .attr('text-anchor', 'middle')
    .attr('class', 'radio-br-text')
    .attr('x', 770)
    .attr('y', radio_br_text_y+25);
svg.append("text")
    .text('6LoWPAN')
    .attr('font-family', 'sans-serif')
    .attr('font-size', '25px')
    .attr('text-anchor', 'middle')
    .attr('class', 'radio-br-text')
    .attr('x', 770)
    .attr('y', radio_br_text_y+50);
svg.append("text")
    .text('+')
    .attr('font-family', 'sans-serif')
    .attr('font-size', '25px')
    .attr('text-anchor', 'middle')
    .attr('class', 'radio-br-text')
    .attr('x', 770)
    .attr('y', radio_br_text_y+75);
svg.append("text")
    .text('RPL')
    .attr('font-family', 'sans-serif')
    .attr('font-size', '25px')
    .attr('text-anchor', 'middle')
    .attr('class', 'radio-br-text')
    .attr('x', 770)
    .attr('y', radio_br_text_y+100);


// Add BLE logo
svg.append("path")
    .attr("d", ble_logo_xml_d)
    .attr("class", "ble-logo")
    .attr("transform", "translate(740,350)");




var radio_bl_pkt = svg.append("circle")
    .attr('r', 15)
    .attr('class', 'radio-bl-circle')
    .attr("transform", "translate(" + radio_bl_points[0] + ")");

var radio_br_pkt = svg.append("circle")
    .attr('r', 15)
    .attr('class', 'radio-br-circle')
    .attr("transform", "translate(" + radio_br_points[0] + ")");





// var ble_advs = [{name:'hi there', id: '56:78:43:12:51:fb', d:4, rssi:56},
//                 {name:'woah', id: 'ad:78:40:12:43:cc', d:5, rssi:32}];
//var ble_advs = ['hi there','woah'];
var ble_advs = [];





function queue_add_text (all_group, enter_group, x, y, text_func, css_class) {
  enter_group.append('text')
      .text(text_func)
      .attr('x', x)
      .attr('y', function(d, i) { return (y + (125*i)) })
      .attr('class', css_class)
      .style("opacity", 0)
    .transition()
      .duration(750)
      .style("opacity", 1);

  all_group.transition().select('text.' + css_class)
      .duration(750)
      .attr('y', function(d, i) { return (y + (125*i)) })
      .style("opacity", 1);
}

function queue_add_rect (all_group, enter_group, x, y, w, h, curve, css_class) {
  enter_group.append('rect')
      .attr('x', x)
      .attr('y', function(d, i) { return (y + (125*i)) })
      .attr('width', w)
      .attr('height', h)
      .attr('rx', curve)
      .attr('ry', curve)
      .attr('class', css_class)
      .style("opacity", 0)
    .transition()
      .duration(750)
      .style("opacity", 1);

  all_group.transition().select('rect.' + css_class)
      .duration(750)
      .attr('y', function(d, i) { return (y + (125*i)) })
      .style("opacity", 1);
}



function display_ble_advertisements () {

  var ble_adv_boxes = svg.selectAll("g.ble-adv")
      .data(ble_advs, function(d) { return d.count; });

  ble_adv_boxes_enter = ble_adv_boxes.enter()
      .append('g')
      .attr('class', 'ble-adv');

  // main bubble
  queue_add_rect(ble_adv_boxes,
                 ble_adv_boxes_enter,
                 ble_adv_x_pos_left,
                 ble_adv_y_pos_top,
                 300,
                 100,
                 20,
                 'ble-adv-bubble');

  // Name
  queue_add_text(ble_adv_boxes,
                 ble_adv_boxes_enter,
                 ble_adv_x_pos_left+20,
                 ble_adv_y_pos_top+40,
                 function(a){return a.name;},
                 'ble-adv-name');


  // ble_adv_boxes_enter.append('text')
  //     .text(function (d) { return d.id })
  //     .attr('x', ble_adv_x_pos_left+20)
  //     .attr('y', function(d, i) { return (ble_adv_y_pos_top+75 + (125*i)) })
  //     .attr('class', 'ble-adv-id')
  //     .style("opacity", 0)
  //   .transition()
  //     .duration(750)
  //     .style("opacity", 1);

  // ID mac
  queue_add_text(ble_adv_boxes,
                 ble_adv_boxes_enter,
                 ble_adv_x_pos_left+20,
                 ble_adv_y_pos_top+75,
                 function(a){return a.id;},
                 'ble-adv-id');

  // ble_adv_boxes_enter.append('rect')
  //     .attr('x', ble_adv_x_pos_left+220)
  //     .attr('y', function(d, i) { return (ble_adv_y_pos_top+20 + (125*i)) })
  //     .attr('width', 60)
  //     .attr('height', 60)
  //     .attr('rx', 10)
  //     .attr('ry', 10)
  //     .attr('class', 'ble-adv-rssi-box')
  //     .style("opacity", 0)
  //   .transition()
  //     .duration(750)
  //     .style("opacity", 1);

  // main bubble
  queue_add_rect(ble_adv_boxes,
                 ble_adv_boxes_enter,
                 ble_adv_x_pos_left+220,
                 ble_adv_y_pos_top+20,
                 60,
                 60,
                 10,
                 'ble-adv-rssi-box');

  // ble_adv_boxes_enter.append('text')
  //     .text('RSSI')
  //     .attr('x', ble_adv_x_pos_left+250)
  //     .attr('y', function(d, i) { return (ble_adv_y_pos_top+40 + (125*i)) })
  //     .attr('class', 'ble-adv-rssi-label')
  //     .style("opacity", 0)
  //   .transition()
  //     .duration(750)
  //     .style("opacity", 1);

  // "RSSI"
  queue_add_text(ble_adv_boxes,
                 ble_adv_boxes_enter,
                 ble_adv_x_pos_left+250,
                 ble_adv_y_pos_top+40,
                 'RSSI',
                 'ble-adv-rssi-label');

  // ble_adv_boxes_enter.append('text')
  //     .text(function (d) { return d.rssi })
  //     .attr('x', ble_adv_x_pos_left+250)
  //     .attr('y', function(d, i) { return (ble_adv_y_pos_top+65 + (125*i)) })
  //     .attr('class', 'ble-adv-rssi')
  //     .style("opacity", 0)
  //   .transition()
  //     .duration(750)
  //     .style("opacity", 1);

  // Name
  queue_add_text(ble_adv_boxes,
                 ble_adv_boxes_enter,
                 ble_adv_x_pos_left+250,
                 ble_adv_y_pos_top+65,
                 function(a){return a.rssi;},
                 'ble-adv-rssi');

  // ble_adv_boxes.transition().select('rect.ble-adv-bubble')
  //     .duration(750)
  //     .attr('y', function(d, i) { return (ble_adv_y_pos_top + (125*i)) })
  //     .style("opacity", 1);

  // ble_adv_boxes.transition().select('text.ble-adv-name')
  //     .duration(750)
  //     .attr('y', function(d, i) { return (ble_adv_y_pos_top+40 + (125*i)) })
  //     .style("opacity", 1);

  // ble_adv_boxes.transition().select('text.ble-adv-id')
  //     .duration(750)
  //     .attr('y', function(d, i) { return (ble_adv_y_pos_top+75 + (125*i)) })
  //     .style("opacity", 1);

  // ble_adv_boxes.transition().select('rect.ble-adv-rssi-box')
  //     .duration(750)
  //     .attr('y', function(d, i) { return (ble_adv_y_pos_top+20 + (125*i)) })
  //     .style("opacity", 1);

  // ble_adv_boxes.transition().select('text.ble-adv-rssi-label')
  //     .duration(750)
  //     .attr('y', function(d, i) { return (ble_adv_y_pos_top+40 + (125*i)) })
  //     .style("opacity", 1);

  // ble_adv_boxes.transition().select('text.ble-adv-rssi')
  //     .duration(750)
  //     .attr('y', function(d, i) { return (ble_adv_y_pos_top+65 + (125*i)) })
  //     .style("opacity", 1);

  ble_adv_boxes.exit()
    .transition()
      .duration(300)
      .style("opacity", 0)
      .remove();
}

display_ble_advertisements();

transition_bl();
transition_br();

function transition_bl() {
  radio_bl_pkt.transition()
      .duration(1000)
      .attrTween("transform", translateAlong(radio_bl_path.node()));
}
function transition_br() {
  radio_br_pkt.transition()
      .duration(1000)
      .attrTween("transform", translateAlong(radio_br_path.node()));
}
function transition_tr() {

  var radio_tr_pkt = svg.append("circle")
      .attr('r', 15)
      .attr('class', 'radio-tr-circle')
      .attr("transform", "translate(" + radio_tr_points[0] + ")");

  radio_tr_pkt.transition()
      .duration(1000)
      .attrTween("transform", translateAlong(radio_tr_path.node()))
      .remove();
}

// Returns an attrTween for translating along the specified path element.
function translateAlong(path) {
  var l = path.getTotalLength();
  return function(d, i, a) {
    return function(t) {
      var p = path.getPointAtLength(t * l);
      return "translate(" + p.x + "," + p.y + ")";
    };
  };
}

function genMAC(){
    var hexDigits = "0123456789ABCDEF";
    var macAddress="";
    for (var i=0; i<6; i++) {
        macAddress+=hexDigits.charAt(Math.round(Math.random()*16));
        macAddress+=hexDigits.charAt(Math.round(Math.random()*16));
        if (i != 5) macAddress+=":";
    }

    return macAddress;
}

var ble_count = 0;

function add_ble () {
  var names = ['squall', 'lkjfds', 'IBEACON', 'storm', 'brad', 'how about long'];
  var ble_data = {};

  ble_data.name = names[Math.floor(Math.random() * names.length)];
  ble_data.id = genMAC();
  ble_data.rssi = Math.floor(Math.random()*78);
  ble_data.count = ble_count;
  ble_count++;

  ble_data.timestamp = Date.now();

  ble_advs.push(ble_data);

  while (ble_advs.length > 3) {
    ble_advs.shift();
  }

  display_ble_advertisements();
  transition_tr();
  //setTimeout(function(){prune_ble();}, 3000);
}

function prune_ble () {
  var cutoff = Date.now() - 3000;

  //console.log(ble_advs[0].timestamp);



  while (ble_advs.length > 0 && ble_advs[0].timestamp < cutoff) {
    ble_advs.shift();
  }
  display_ble_advertisements();
  //setTimeout(function(){prune_ble();}, 1000);
}

//setTimeout(function(){prune_ble();}, 1000);

</script>
